{
    "collab_server" : "",
    "contents" : "# Data exploration: trying to figure out the data Juha gave me for \n# the Stand Reconstruction (SR) sites.\n#\n# June 28, 2016\n# CBoisvenue\n#--------------------------------------------------------------------\n\nlibrary(data.table)\n\njdir = \"C:/Celine/Syndocs/RES_Work/Work/StandReconstruction/Juha/data/\"\n\nlist.files(paste(jdir,\"site&biomass\",sep=\"\"))\n# [1] \"DataDocumentation.xlsx\"     \"DataProcessingScript.r\"     \"MeasData.csv\"              \n# [4] \"PlotData.csv\"               \"StandGrowth_BiomassDBH.csv\" \"StudyData.csv\"             \n# [7] \"TreeData.csv\"               \"TreeGrowth.csv\"      \n\ntree <- fread(paste(jdir,\"site&biomass/TreeGrowth.csv\",sep=\"\"))\n\nplt <-fread(paste(jdir,\"site&biomass/StandGrowth_BiomassDBHHT.csv\",sep=\"\"))\n\n# To do:\n# sum the tree-level increment to make sure they match the plot-level increments\n# tree-level biomass is in kg \n#\n# figure out the years covered by each plot - how many go before 1945?\n# FetchClimate goes back to 1943 \n#(H:\\Celine_other\\Brenton Chookolingo\\Complete Package\\Climate Data\\Fetch Climate\\Fetch Climate Canadian Dataset.csv)\n# The db1 goes from 2000 to 2014 because it is linked to MODIS NPP\n\n\n#------------------------------------------------------------------------------\n# sum ind tree increments to see how it compares to plot level...\n# summing the biomass calculated using dbh and ht equations from Lambert et al.\nsum.tree <- tree[,.(all.tinc = sum(BIOIdh)), by=.(StudyName,PlotID,Year)]\nsetkey(sum.tree,StudyName,PlotID)\n# apparently we need the study name to get the same no of lines of the plt data...\nunique(tree$StudyName)\n# [1] \"BCDF49\"                 \"BermsOA\"                \"BermsOBS\"              \n# [4] \"BermsOJP\"               \"CandleLakeOJP\"          \"DFFert\"                \n# [7] \"FtSmith\"                \"Inuvik\"                 \"OBSThompson\"           \n# [10] \"PhDThesis\"              \"ThunderBaySpacingTrial\"\n\n# need the plot size\nstudy <- fread(paste(jdir,\"site&biomass/StudyData.csv\",sep=\"\"))\nsize <- study[,.(StudyName,PlotID,PlotSize)]\nsetkey(size,StudyName,PlotID)\nplot1 <- merge(sum.tree,size)\nplot1 <- plot1[,biomha := all.tinc*10000/PlotSize]\nplot2 <- plot1[,c(\"all.tinc\",\"PlotSize\") := NULL]\nsetkey(plot2,StudyName,PlotID,Year)\nsetkey(plt,StudyName,PlotID,Year)\n# the lines should exactly match here, both dt have 5232 lines\nunitcheck <- merge(plot2,plt)\ncheck1 <- unitcheck$biomha - unitcheck$AnnualIncrement\nrange(check1)\n# [1] -5.000402e-09  4.998356e-09\n# check finished: they are the same---------------------------------------------\n\n# year range per plot-----------------------------------\npltyr <- plt[,.(first.yr = min(Year), last.yr = max(Year)),by=.(StudyName,PlotID)]\ndim(pltyr)\n#[1] 64  4\npre1945 <- pltyr[first.yr<1945]\ndim(pre1945)\n#[1] 36  4\n# finished year range ---------------------------------\n\n# how many plots?--------------------------------------\nno.plt <- unique(plt[,.(StudyName,PlotID)]) # 64\nplt.tree <- unique(tree[,.(StudyName,PlotID)]) #64\nno.study <- unique(study[,.(StudyName,PlotID)]) #981\nsetkey(no.study,StudyName,PlotID)\nsetkey(no.plt,StudyName,PlotID)\nsetkey(plt.tree,StudyName,PlotID)\nno.plt %in% plt.tree\nwhich(no.plt != plt.tree)\n#integer(0)\nwhich(no.plt == plt.tree)\n# works these are equal\n\n# which of the 981 is not in those two?\n#no.match <- subset(no.study, !(no.study %in% plt.tree))\nmatches <- which(no.study %in% plt.tree)\n## ??? I have no answer question for Juha--------------\n\n# get UTMs to JWhite--------------------------------------------\n# Juha has 981 plots\n\n## July 15  JW identified a problem with the CIPHA plots: the northings are all negative (I see\n## why that is in the code below: the code I copied said to add a negative but my values are \n## already negative)\n## Other problem JW identified is that the other UTMs (not CIPHA plot) all have low precision \n## on the UTMs. I am now calculating the UTMs from the Lat Lon of Brenton's db instead of taking\n## the UTMs values from the study information to see if there is a difference in precision\n\n# this is where I took the UTMs from the study info\ndim(study)\n#[1] 981  19\nutm <- study[,.(StudyName,PlotID,PlotSize,UTMZone,Easting,Northing)]\n# this db seems to have 1056 plots\n##\n\n\ndb1 <- fread(\"M:/Brenton/MODIS Climate Database v11.csv\")\n# there are a bunch of missing years\n# get rid of them\ndb2 <- db1[!is.na(Year)]\n# check if previous versions of the db had NAs\n#db3 <- read.table(file=\"C:/Celine/Syndocs/RES_Work/Work/BrentonChookolingo/MODIS_Climate Database v4.csv\",sep=\",\")\n# can't read that in...not sure why\ndb3 <- unique(db2[,.(Study.Name,Plot.ID,Latitude,Longitude)])\ndim(db3)\n#[1] 1056    4\n\n# how many of these are CIPHA\ndb4 <-  db3[Study.Name==\"CIPHA\"]\ndim(db4)\n#[1] 75  4\n981+75\n# it adds up\n# need to get UTMs for CIPHA plots\nhead(db4)\n# added this line below to check on the UTM low precision issue\ndb4.1 <- unique(db2[Study.Name!=\"CIPHA\",.(Study.Name,Plot.ID,Latitude,Longitude)])\n# 981 plots\n\n# to get the zone (function off http://stackoverflow.com/)\nlong2UTM <- function(long) {\n  (floor((long + 180)/6) %% 60) + 1\n}\n\ndb5 <- db4[,zone:= long2UTM(Longitude)]\nunique(db5$zone)\n#[1] 14 13 12 11 10\n\n## added the lones below to check on the low precision UTM issue\ndb5.1 <- db4.1[,zone:= long2UTM(Longitude)]\nzones <- unique(db5.1$zone)\n#[1] 16 10 13 14 12  8\n\nlibrary(sp)\nlibrary(rgdal)\n\nsp1 <- SpatialPoints(cbind(db4$Longitude, db4$Latitude), proj4string=CRS(\"+proj=longlat\"))\nwhich(db4$zone==14)\nwhich(db4$zone==13)\nwhich(db4$zone==12)\nwhich(db4$zone==11)\nwhich(db4$zone==10)\ncipha14 <- as.data.frame(spTransform(sp1[which(db4$zone==14)],CRS(\"+proj=utm +zone=14\")))\ncipha13 <- as.data.frame(spTransform(sp1[which(db4$zone==13)],CRS(\"+proj=utm +zone=13\")))\ncipha12 <- as.data.frame(spTransform(sp1[which(db4$zone==12)],CRS(\"+proj=utm +zone=12\")))\ncipha11 <- as.data.frame(spTransform(sp1[which(db4$zone==11)],CRS(\"+proj=utm +zone=11\")))\ncipha10 <- as.data.frame(spTransform(sp1[which(db4$zone==10)],CRS(\"+proj=utm +zone=10\")))\n\n# for all the other plots - checking is the UTMs in the study file is the same as that in the \n# Brenton db\nsp2 <- SpatialPoints(cbind(db4.1$Longitude, db4.1$Latitude), proj4string=CRS(\"+proj=longlat\"))\nstandRecOnlyUTMs <- as.data.frame(spTransform(sp2[which(db4.1$zone==zones[1])],\n                                              CRS(paste(\"+proj=utm +zone=\",zones[1],sep=\"\"))))\nfor(i in 2:length(zones)){\n  newUTMs <- as.data.frame(spTransform(sp2[which(db4.1$zone==zones[i])],\n                                       CRS(paste(\"+proj=utm +zone=\",zones[2],sep=\"\"))))\n  standRecOnlyUTMs <- as.data.table(rbind(standRecOnlyUTMs,newUTMs))\n}\nsetnames(standRecOnlyUTMs,names(standRecOnlyUTMs),c(\"Easting\",\"Northing\"))\n\n\ncipha <- as.data.table(rbind(cipha14,cipha13,cipha12,cipha11,cipha10))\nsetnames(cipha,names(cipha),c(\"Easting\",\"Northing\"))\n\ndb6 <- db5[,.(Study.Name,Plot.ID,zone)]\nPlotSize <- rep(400,75)\nciphaAll <- cbind(db6,PlotSize,cipha)\nsetnames(ciphaAll,names(ciphaAll),c(\"StudyName\",\"PlotID\",\"UTMZone\",\"PlotSize\",\"Easting\",\"Northing\"))\nsetcolorder(ciphaAll,c(\"StudyName\",\"PlotID\",\"PlotSize\",\"UTMZone\",\"Easting\",\"Northing\"))\n# fixed the low-precision utm so new file below\n#StandRecUTM <- rbind(utm,ciphaAll)\n#write.table(StandRecUTM,file=\"C:/Celine/Syndocs/RES_Work/Work/StandReconstruction/work/data/standRecUTMs.csv\",sep=\",\",row.names = FALSE)\n\n# stand Rec only\ndb6.1 <- db5.1[,.(Study.Name,Plot.ID,zone)]\nstudy2 <- fread(paste(jdir,\"site&biomass/StudyDataPlotNamesChgdToMatch.csv\",sep=\"\"))\nrecPlotSize <- study2[,.(StudyName,PlotID,PlotSize)]\nsetkey(recPlotSize,StudyName,PlotID)\nrecPlotsAll <- cbind(db6.1,standRecOnlyUTMs)\nsetnames(recPlotsAll,names(recPlotsAll),c(\"StudyName\",\"PlotID\",\"UTMZone\",\"Easting\",\"Northing\"))\nsetkey(recPlotsAll,StudyName,PlotID)\n\n#Fixed: the names did not match between the \"StudyData.csv\", where we get plot sizes, \n# and the climate db. \n### I changed the names in the StudyData.csv and saved is as StudyDataPlotNamesChgdToMatch.csv\nrecPlotsUTMs <- merge(recPlotsAll,recPlotSize)\n#FIXED### LOOSING 37 plots in the merge - WHY???\n# recPlotsUTMs2 <- merge(recPlotsAll,recPlotSize, all=TRUE)\n# missingplots <-recPlotsUTMs2[is.na(PlotSize),]\n# BermsOA1 <- recPlotsAll[StudyName==\"BermsOA\",]\n# BermsOA2 <- recPlotSize[StudyName==\"BermsOA\",]\n# found the problem\n\n\nunique(recPlotsUTMs$StudyName)\nunique(recPlotSize$StudyName)\n\nsetcolorder(recPlotsUTMs,c(\"StudyName\",\"PlotID\",\"PlotSize\",\"UTMZone\",\"Easting\",\"Northing\"))\nallPlotsUTMS <- rbind(recPlotsUTMs,ciphaAll)\nwrite.table(allPlotsUTMS,file=\"C:/Celine/Syndocs/RES_Work/Work/StandReconstruction/work/data/standRecUTMs.csv\",sep=\",\",row.names = FALSE)\n## something wrong with the precision of the plots, so need to check on process of \n##converting lat lon to UTMs\n# for now send db3 to Joanne White\nwrite.table(db3,file=\"C:/Celine/Syndocs/RES_Work/Work/StandReconstruction/work/data/standRecLatLong.csv\",sep=\",\",row.names = FALSE)\n\n\n# UTMs and plot size to JWhite completed----------------------------------------\n\n\n# tree diameter diameter range? (in PlotData.csv) ------------------------------------------------\nplotData <- fread(paste(jdir,\"site&biomass/PlotData.csv\",sep=\"\"))\nno.data <- unique(plotData[,.(StudyName,PlotID)]) # 985 \n\n# diameter range by species\nsps.dbh <- plotData[,.(lowdbh = min(DBH), highdbh = max(DBH)), by = .(StudyName,PlotID,Species,MeasNo)]\n# There is a range of dbh by species by plots by measurement\nplt.dbh <- plotData[,.(lowdbh = min(DBH), highdbh = max(DBH)), by = .(StudyName,PlotID,MeasNo)]\ntable(plt.dbh$lowdbh)\n# there are small trees measured\n# dbh finished------------------------------------------------------------------------------------\n\n\n# tree species? (in PlotData.csv)--------------------------------------------------\nplt.sps <- plotData[,.(no.sps = .N),by=.(StudyName,PlotID,Species,MeasNo)]\nsps.chg <- dcast(plt.sps, StudyName+PlotID+Species ~ MeasNo, value.var = \"no.sps\")\nsetnames(sps.chg,names(sps.chg),c(\"StudyName\",\"PlotID\",\"Species\",\"meas0\",\"meas3\"))\nsetkey(sps.chg,StudyName,PlotID)\n\nsps.count <- sps.chg[,.(tot.count = sum(meas0),dom = max(meas0)),by=.(StudyName,PlotID)]\nsetkey(sps.count,StudyName,PlotID)\n\ndom1 <- merge(sps.chg[,.(StudyName,PlotID,Species,meas0)],sps.count)\ndom <- dom1[meas0==dom,.(domSps = Species,prop=dom/tot.count),by=.(StudyName,PlotID)]\n# species finished---------------------------------------------------------------\n\n\n# plot-level biomass-------------------------------------------------------------\n# these estimates are from the sum of the individual tree-level biomass calculated using\n# Lambert et al equations with dbh and ht as predictor variables.\nplt.biom <- merge(plt[,.(StudyName,PlotID,Year, AnnualIncrement, Density)],dom)\n\nwrite.table(plt.biom,file=\"C:/Celine/Syndocs/RES_Work/Work/StandReconstruction/work/data/plotBiomHa.csv\",sep=\",\",row.names = FALSE)\n\n\n\n",
    "created" : 1481064233181.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1625536437",
    "id" : "20563665",
    "lastKnownWriteTime" : 1468865314,
    "last_content_update" : 1468865314,
    "path" : "C:/Celine/GitHub/R_collaboration/ExploreSRdata.r",
    "project_path" : "ExploreSRdata.r",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}